<?xml version="1.0" encoding="utf-8" ?>
<odoo>
    <template id="portal_my_home_helpdesk" name="Portal layout : helpdesk tickets menu entries"
              inherit_id="portal.portal_breadcrumbs" priority="50">
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
            <li t-if="page_name == 'ticket' or ticket"
                t-attf-class="breadcrumb-item #{'active ' if not ticket else ''}">
                <a t-if="ticket" t-attf-href="/my/tickets?{{ keep_query() }}">
                    Tickets
                </a>
                <t t-else="">
                    Tickets
                </t>
            </li>
            <li t-if="ticket" class="breadcrumb-item active text-truncate">
                <span t-field="ticket.code"/> - <span t-field="ticket.name"/>
            </li>
        </xpath>
    </template>

    <template id="portal_my_home_helpdesk_ticket" name="Helpdesk Tickets" inherit_id="portal.portal_my_home"
              priority="50" customize_show="True">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="title">Tickets</t>
                <t t-set="url" t-value="'/my/tickets'" />
                <t t-set="placeholder_count" t-value="'ticket_count'"/>
            </t>
        </xpath>
    </template>

    <template id="portal_helpdesk_ticket" name="My Tickets">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <t t-call="portal.portal_searchbar">
                <t t-set="title">Tickets</t>
            </t>
            <form method="POST" t-attf-action="/helpdesk/ticket/new">
                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                <button name="submit_ticket" type="action" class="btn btn-primary"
                        style="float: right; margin-right: 0px; margin-bottom: 5px;">
                    New Ticket
                </button>
            </form>
            <div t-if="not grouped_tickets" class="alert alert-info">
                No tickets found.
            </div>
            <t t-call="helpdesk_mngmnt.portal_helpdesk_ticket_list"/>
        </t>
    </template>

    <template id="portal_helpdesk_ticket_list" name="Helpdesk Tickets List">
        <t t-if="grouped_tickets">
            <t t-call="portal.portal_table">
                <thead>
                    <tr>
                        <th>Ticket</th>
                        <th class="text-end" t-if="groupby != 'create_date'">Reported on</th>
                        <th id="ticket_user_header" t-if="groupby != 'user_id'" class="ps-5">Assigned to</th>
                        <th t-if="groupby != 'stage_id'" colspan="5" class="text-end">Stage</th>
                    </tr>
                </thead>
                <t t-foreach="grouped_tickets" t-as="tickets">
                    <tbody>
                        <tr t-if="not groupby =='none'" class="table-light">
                            <th t-if="groupby == 'stage_id'" colspan="5">
                                <span t-field="tickets[0].stage_id.name"/>
                            </th>
                            <th t-if="groupby == 'user_id'" colspan="5">
                                <span t-if="tickets[0].user_id" t-out="tickets[0].user_id.name"/>
                                <span t-else="">Unassigned</span>
                            </th>
                            <th t-if="groupby == 'create_date'" colspan="5">
                                <span t-field="tickets[0].create_date"/>
                            </th>
                            <th t-if="groupby == 'partner_id'" colspan="6">
                                <span t-if="tickets[0].partner_id" t-field="tickets[0].partner_id.name"/>
                                <span t-else="">No Customer</span>
                            </th>
                        </tr>
                    </tbody>
                    <t t-foreach="tickets" t-as="ticket">
                        <tr>
                            <td class="text-start">
                                <a t-attf-href="/helpdesk/ticket/#{ticket.id}">
                                    <small>#</small>
                                    <t t-out="ticket.code"/>
                                    <span class="ms-2" t-att-title="ticket.name" t-field="ticket.name"/>
                                </a>
                            </td>
                            <td class="text-end" t-if="groupby != 'create_date'">
                                <span t-field="ticket.create_date"
                                      t-options="{'widget': 'datetime', 'hide_seconds': True}"/>
                            </td>
                            <td id="ticket_user_body" t-if="groupby != 'user_id'" class="ps-5 lh-1">
                                <img t-if="ticket.user_id" class="o_avatar o_portal_contact_img rounded"
                                     t-attf-src="#{image_data_uri(ticket.user_id.sudo().avatar_128)}"
                                     alt="Contact"/>
                                <span t-field="ticket.user_id"/>
                            </td>
                            <td t-if="groupby != 'stage_id'" class="text-end">
                                <span t-attf-class="badge rounded-pill fw-normal #{'text-bg-success' if ticket.stage_id.fold else 'text-bg-primary'}"
                                      t-esc="ticket.stage_id.name"/>
                            </td>
                        </tr>
                    </t>
                </t>
            </t>
        </t>
    </template>

    <template id="portal_helpdesk_ticket_form" name="Helpdesk Ticket">
        <t t-call="portal.portal_layout">
            <t t-set="title" t-value="ticket.name"/>
            <t t-set="wrapwrap_classes" t-value="'o_portal_bg_dark'"/>

            <div class="row mt16 o_project_portal_sidebar">
                <t t-call="portal.portal_record_sidebar">
                    <t t-set="classes" t-value="'col-lg-4 col-xxl-3 d-print-none'"/>

                    <t t-set="entries">
                        <div class="d-flex flex-column">
                            <div id="ticket-links" t-if="ticket_link_section" class="flex-grow-1" t-ignore="true"
                                 role="complementary" invisible="1">
                                <ul class="nav flex-column">
                                    <t t-foreach="sorted(ticket_link_section, key=lambda r: r['sequence'])"
                                       t-as="ticket_link">
                                        <li class="nav-item">
                                            <a class="nav-link p-0" t-att-href="ticket_link['access_url']">
                                                <t t-out="ticket_link['title']"/>
                                            </a>
                                        </li>
                                    </t>
                                </ul>
                            </div>

                            <div t-if="ticket.user_id or ticket.partner_id" class="mt-4">
                                <div t-attf-class="col-12 col-md-12" t-if="ticket.user_id">
                                    <h6>
                                        <small class="text-muted">Assigned to</small>
                                    </h6>
                                    <div class="d-flex ps-3 flex-nowrap">
                                        <img class="rounded-circle mt-1 o_portal_contact_img"
                                             t-att-src="image_data_uri(ticket.user_id.avatar_1024)" alt="Contact"/>
                                        <div class="ms-2">
                                            <div t-out="ticket.user_id"
                                                 t-options="{'widget': 'contact', 'fields': ['name']}" class="mt-2"/>
                                        </div>
                                    </div>
                                </div>
                                <div t-attf-class="col-12 col-md-12 {{ 'mt-3' if ticket.user_id.name else '' }}"
                                     t-if="ticket.partner_id">
                                     <h6>
                                        <small class="text-muted">Customer</small>
                                    </h6>
                                    <div class="d-flex ps-3 flex-nowrap">
                                        <img class="rounded-circle mt-1 o_portal_contact_img"
                                             t-att-src="image_data_uri(ticket.partner_id.avatar_1024)" alt="Contact"/>
                                        <div class="ms-2">
                                            <div t-field="ticket.partner_id"
                                                 t-options="{'widget': 'contact', 'fields': ['name']}"/>
                                            <a t-attf-href="mailto:{{ticket.partner_id.email}}"
                                               t-if="ticket.partner_id.email">
                                                <div t-field="ticket.partner_id"
                                                     t-options="{'widget': 'contact', 'fields': ['email']}"/>
                                            </a>
                                            <a t-attf-href="tel:{{ticket.partner_id.phone}}"
                                               t-if="ticket.partner_id.phone">
                                                <div t-field="ticket.partner_id"
                                                     t-options="{'widget': 'contact', 'fields': ['phone']}"/>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </t>
                <div id="ticket_content" class="o_portal_content col-12 col-lg-8 col-xxl-9 mt-5 mt-lg-0">
                    <div t-if="ticket_closed" class="alert alert-success alert-dismissible d-print-none" role="status">
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"/>
                        <span>Your ticket has successfully been closed. Thank you for your collaboration.</span>
                    </div>
                    <div id="card">
                        <div id="card_header" class="container" data-anchor="true">
                            <div class="row gs-0">
                                <div class="col-md">
                                    <h5 class="row justify-content-between">
                                        <div class="col-md-9 text-truncate">
                                            <span t-field="ticket.name" class="h3"/>
                                            <small class="text-muted"> (#<span t-field="ticket.code"/>)</small>
                                        </div>
                                        <div class="col col-auto">
                                            <small>Stage:</small>
                                            <small t-field="ticket.stage_id.name"
                                                   t-attf-class="badge rounded-pill smaller #{'text-bg-info' if ticket.stage_id.fold else 'text-bg-light bg-200'}"
                                                   title="Current stage of this ticket"/>
                                        </div>
                                    </h5>
                                </div>
                            </div>
                        </div>
                        <div id="card_body">
                            <div class="row mb-4">
                                <strong class="col-lg-3">Reported on</strong>
                                <span class="col-lg-9" t-field="ticket.create_date"
                                      t-options="{'widget': 'datetime', 'hide_seconds': True}"/>
                            </div>
                            <div t-if="not is_html_empty(ticket.description)" class="row mt-3" name="description">
                                <div class="col-lg-12" t-field="ticket.description"/>
                            </div>
                        </div>
                    </div>

                    <hr/>
                    <div class="o_portal_messages_container" id="ticket_chat" data-anchor="true">
                        <h3>Communication history</h3>
                        <t t-call="portal.message_thread">
                            <t t-set="token" t-value="ticket.access_token"/>
                            <t t-set="disable_composer" t-value="ticket.stage_id.fold"/>
                        </t>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <template id="portal_helpdesk_ticket_submit_form" name="Submit Ticket">
        <t t-call="portal.portal_layout">
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <h1 class="text-center">Submit A Ticket</h1>
                    </div>
                </div>
            </div>
            <form action="/submitted/ticket" method="POST" class="form-horizontal mt32" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
<!--                <div class="form-group" t-if="teams">-->
<!--                    <label class="col-md-3 col-sm-4 control-label" for="team">Team</label>-->
<!--                    <div class="col-md-7 col-sm-8">-->
<!--                        <select class="form-control" id="team" name="team" t-att-required="ticket_team_id_required">-->
<!--                            <option value="" />-->
<!--                            <t t-foreach="teams" t-as="team">-->
<!--                                <option t-attf-value="#{team.id}">-->
<!--                                    <t t-esc="team.name" />-->
<!--                                </option>-->
<!--                            </t>-->
<!--                        </select>-->
<!--                    </div>-->
<!--                </div>-->
                <div class="form-group">
                    <label class="col-md-3 col-sm-4 control-label" for="type">
                        Type
                    </label>
                    <div class="col-md-7 col-sm-8">
                        <select class="form-control" id="type" name="type" t-att-required="True">
                            <option value=""/>
                            <t t-foreach="types" t-as="type">
                                <option t-attf-value="#{type.id}">
                                    <t t-esc="type.name"/>
                                </option>
                            </t>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 col-sm-4 control-label" for="subject">
                        Subject
                    </label>
                    <div class="col-md-7 col-sm-8">
                        <input type="text" class="form-control" name="subject" required="True"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 col-dm-4 control-label" for="description">
                        Description
                    </label>
                    <div class="col-md-7 col-sm-8">
                        <textarea class="form-control" name="description" style="min-height: 120px" required="True"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 col-sm-4 control-label" for="attachment">
                        Attachments
                    </label>
                    <div class="col-md-7 col-sm-8">
                        <div class="btn btn-default btn-file col-md-12">
                            <input class="form-control o_website_form_input" name="attachment" id="attachment"
                                   type="file" multiple="multiple" t-att-max_upload_size="max_upload_size"/>
                        </div>
                        <div id="attachment_information" style="display: none;" class="text-danger"/>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-md-offset-3 col-sm-offset-4 col-sm-8 col-md-7">
                        <button class="btn btn-primary btn-lg">Submit Ticket</button>
                    </div>
                </div>
            </form>
        </t>
    </template>
</odoo>
